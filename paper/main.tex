\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{microtype}
\usepackage{hyperref}
\usepackage{titlesec}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{tikz}
\usetikzlibrary{positioning,arrows.meta,shapes.misc,fit,calc}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{adjustbox} % for \adjustbox max width

\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  urlcolor=blue,
  citecolor=blue,
  pdfauthor={Ankit Malhotra},
  pdftitle={CRIITS: A Transaction-Agnostic State Machine},
}

\titleformat{\section}[block]{\large\bfseries}{--}{0pt}{}
\titleformat{\subsection}[block]{\normalsize\bfseries}{--}{0pt}{}

\lstdefinelanguage{json}{
    basicstyle=\ttfamily\small,
    numbers=left,
    numberstyle=\tiny,
    stepnumber=1,
    numbersep=5pt,
    showstringspaces=false,
    breaklines=true,
    frame=single,
}
\lstset{
  basicstyle=\ttfamily\small,
  frame=single,
  breaklines=true,
  showstringspaces=false
}

\begin{document}
\begin{titlepage}
\centering
\vspace*{1cm}
{\Huge \textbf{CRIITS}}\par
\vspace{0.4cm}
{\Large A Transaction-Agnostic State Machine for Reliable End-to-End Processing}\par
\vspace{1.5cm}
{\large \textbf{Author:} Ankit Malhotra}\par
\vspace{0.2cm}
Version 2.1 \quad | \quad Date: 25 September 2025\par

% --- DOI badge (clickable) ---
\vspace{0.5cm}

\vfill
\begin{tabular}{p{0.9\textwidth}}
\textbf{Abstract}\\[0.2cm]
Modern transactional systems span multiple services and networks. Failures, retries, and out-of-order delivery make it hard to guarantee that no transaction is missed. CRIITS defines four canonical phases—CR (Created), I (Initiated), I (0..n Intermediary), and TS (Terminal State)—plus operating invariants, a reference architecture, and a polling \& reconciliation strategy to deliver observability and finality across domains.\\[0.3cm]
\textbf{License}: CC BY 4.0 \quad \textbar\  \textbf{Contact}: \href{mailto:connect@ankitmalhotra.com}{connect@ankitmalhotra.com} \quad \textbar\  \textbf{DOI}: \href{https://doi.org/10.5281/zenodo.17132329}{10.5281/zenodo.17132329}\\
\end{tabular}
\vfill
\end{titlepage}

\tableofcontents
\newpage

\section{The CRIITS Model}
\subsection{Canonical States}
\begin{itemize}[leftmargin=*]
\item \textbf{CR — Created}: Transaction accepted by the system of record (SOR). ID minted, minimal validation passed, persistence guaranteed.
\item \textbf{I — Initiated}: Execution has started (request sent to downstream or workflow engaged).
\item \textbf{I — Intermediary (0..n)}: Checkpoints representing externally verifiable progress.
\item \textbf{TS — Terminal State}: Finality with mutually exclusive outcomes: TS.SUCCEEDED, TS.FAILED, TS.EXPIRED.
\end{itemize}

\subsection{State Machine Diagram}
\begin{figure}[h]
\centering
\begin{adjustbox}{max width=\textwidth}
\begin{tikzpicture}[>=Latex, node distance=2.2cm, every node/.style={font=\small}]
\tikzstyle{state}=[rectangle, rounded corners, draw, minimum width=2.6cm, minimum height=0.9cm, align=center, fill=gray!5]

% Strictly horizontal pipeline
\node[state] (cr) {CR\\Created};
\node[state, right=2.0cm of cr] (i) {I\\Initiated};
\node[state, right=2.0cm of i] (ic1) {I.CHK1};
\node[state, right=2.0cm of ic1] (ic2) {I.CHK2};
\node[state, right=2.0cm of ic2] (ts) {TS.\{SUCCEEDED\;|\;FAILED\;|\;EXPIRED\}};

% Edges
\draw[->] (cr) -- node[above] {start} (i);
\draw[->] (i) -- node[above] {vendor\_ack} (ic1);
\draw[->] (ic1) -- node[above] {progress} (ic2);
\draw[->] (ic2) -- node[above] {finalize} (ts);
\draw[->, dashed] (i) to[bend right=15] node[below] {timeout} (ts);

% Notes
\node[draw, align=left, rounded corners, fill=blue!3, inner sep=6pt, above=0.8cm of ic1] (legend) {%
\textbf{Notes}: Forward-only transitions; 0..n checkpoints; TS is immutable.};
\end{tikzpicture}
\end{adjustbox}
\caption{CRIITS state machine laid out in a single horizontal line; auto-scaled to page width.}
\end{figure}

\section{Reference Architecture}

\subsection{Component Diagram}
\begin{figure}[h]
\centering
\begin{adjustbox}{max width=\textwidth}
\begin{tikzpicture}[>=Latex, node distance=1.4cm, every node/.style={font=\small}]
\tikzstyle{comp}=[rectangle, draw, rounded corners, minimum width=3.4cm, minimum height=1.0cm, align=center, fill=gray!5]

% Top row (purely horizontal)
\node[comp] (clients) {Clients / Producers};
\node[comp, right=2.2cm of clients] (tg) {Transaction Gateway\\(mint \texttt{tid}, write CR)};
\node[comp, right=2.2cm of tg] (elog) {Append-only Event Log\\(Kafka/Pulsar/DB)};
\node[comp, right=2.2cm of elog] (vendors) {External Vendors\\(idempotent APIs/files)};

% Bottom row (still horizontal)
\node[comp, below=1.2cm of tg] (orch) {Orchestrator / Workers\\(emit I/TS events)};
\node[comp, below=1.2cm of elog] (proj) {State Projection\\(\texttt{tx\_head} view)};
\node[comp, below=1.2cm of vendors] (poll) {Poller / Reconciler\\(adaptive backoff + files)};
\node[comp, below=1.2cm of clients, xshift=0.0cm] (dlq) {Dead-Letter \& Triage};

% Connections kept clean and horizontal where possible
\draw[->] (clients) -- (tg);
\draw[->] (tg) -- node[above] {CR} (elog);
\draw[->] (orch) -- (elog);
\draw[->] (elog) -- (proj);
\draw[->] (proj) -- (poll);
\draw[->] (orch) -- (dlq);
\draw[->] (orch.east) .. controls +(1.8,0.0) and +(-1.8,0.0) .. node[above] {idempotent calls} (vendors.west);
\draw[->] (poll.north) -- ++(0,0.6) -| node[pos=0.25, above] {reconcile} (vendors.south);

% Group box for core
\node[draw, dashed, rounded corners, fit=(tg) (elog) (orch) (proj) (poll) (dlq), label={[align=center]north:Core CRIITS Services}, inner sep=8pt] {};
\end{tikzpicture}
\end{adjustbox}
\caption{All boxes arranged left-to-right; scaled to fit page width.}
\end{figure}

\section{Implementation Guide}
\subsection{Minimal Data Model (SQL)}
\lstinputlisting[language=SQL]{sql/ddl.sql}

\subsection{REST Interface (Sketch)}
\begin{lstlisting}[language=]
POST /transactions           -> returns tid (CR recorded)
POST /transactions/{tid}/events  -> advances state (idempotency_key required)
GET  /transactions/{tid}     -> current state + timeline
GET  /transactions?state!=TS.*&stalled_gt=5m  -> for poller
\end{lstlisting}

\subsection{Polling \& Reconciliation}
Adaptive backoff: immediately after I, poll at 10s cadence; after 5 minutes, widen to 30s; after 30 minutes, 2m; cap at 10m. Reset cadence upon any new event.
Reconciliation loop periodically ingests authoritative lists from vendors (e.g., settlement files, KYC batches) and writes missing I/TS events retroactively with observed timestamps from evidence.

\subsection{Idempotency \& Concurrency}
Producer rule: reuse the same idempotency key for a logical effect. Consumer rule: de-dupe on idempotency key. Use optimistic concurrency on projection head.

\subsection{Timeouts, Retries, Escalation}
Per-state TTL; retry budgets; on exhaustion, TS.EXPIRED with reason code. Automatic ticketing for SLO breaches.

\section{Observability \& SLOs}
\subsection{Core Metrics}
Time-to-Finality (CR$\to$TS), Stalled Rate (I-state dwell beyond TTL), Missed-by-Push vs Rescued-by-Poll, Duplicate Event Rate, Transition Error Rate.
\subsection{Dashboards}
Funnel CR$\to$I$\to$I*$\to$TS by cohort; dwell heatmaps; top failure codes.

\section{Security, Compliance, Audit}
Data minimization and encryption; append-only log with checksums; PII/PCI segregation; retention and archiving.

\section{Case Studies (Domain-Agnostic)}
\subsection{Payment Authorization \& Capture}
CR: order created; I: auth initiated; I: 3-DS; I: AUTHORIZED; I: CAPTURE\_PENDING; TS: SUCCEEDED/FAILED/EXPIRED.
\subsection{KYC Verification}
CR: KYC submitted; I: vendor hit; I: MATCHED/MISMATCH/MANUAL\_REVIEW; TS: APPROVED/REJECTED/EXPIRED.
\subsection{Logistics Fulfilment}
CR: shipment created; I: pickup; I: in-transit; TS: DELIVERED/RTO/LOST.

\section{Adoption Playbook \& Maturity}
Level 0: map existing statuses; Level 1: emit events; Level 2: outbox + poller; Level 3: SLOs \& automated reconciliation; Level 4: vendor contracts reference CRIITS states.

\section{Limitations \& Future Work}
CRIITS standardizes observation, not business workflows; some ecosystems lack reliable reconciliation APIs. Future: reference DSL, open schemas, conformance tests.

\section{Conclusion}
Confining lifecycles to CR $\to$ I $\to$ I* $\to$ TS with strict invariants, idempotency, and push+poll recovery yields uniform observability and measurable finality with minimal disruption.

\appendix
\section{Appendix A: State \& Reason Codes}
\begin{itemize}[leftmargin=*]
\item CR
\item I.* (namespaced): I.AUTH\_REQUIRED, I.AUTHORIZED, I.CAPTURE\_PENDING
\item TS.SUCCEEDED \textbar\ TS.FAILED \textbar\ TS.EXPIRED
\end{itemize}
Reason codes (examples): PG\_DECLINED, TIMEOUT, INVALID\_INPUT, RETRY\_BUDGET\_EXCEEDED, DOWNSTREAM\_5XX, HUMAN\_REJECTED.

\section{Appendix B: Sample Event (JSON)}
\begin{lstlisting}[language=json]
{
  "tid": "8c2e8b3c-2e3d-4c7d-9c1a-8f07c5f2c901",
  "from_state": "I.AUTHORIZED",
  "to_state": "TS.SUCCEEDED",
  "event_type": "success_confirmed",
  "idempotency_key": "auth-8c2e8b3c-...-try-1",
  "producer": "capture-worker-v3",
  "observed_at": "2025-09-12T07:10:12Z",
  "evidence": {
    "pg_ref": "PG12345",
    "amount_minor": 129900,
    "currency": "INR",
    "files": [{"type":"settlement","uri":"s3://.../2025-09-12/settlement.csv"}]
  },
  "causation_id": "a2ff7e84-...-42",
  "correlation_id": "order-5b7..."
}
\end{lstlisting}

\section{Appendix C: Querying Stalled Transactions (SQL)}
\begin{lstlisting}[language=SQL]
SELECT tid, state, last_changed_at
FROM tx_head
WHERE state LIKE 'I.%'
  AND last_changed_at < now() - interval '15 minutes';
\end{lstlisting}

\end{document}
